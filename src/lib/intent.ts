/* โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 *  detectIntent.ts
 *  ะะฐัะฟะพะทะฝะฐัะผ ยซะฑัััััะตยป ะฒะพะฟัะพัั ะณะพััะตะน ะฑะตะท ะปะธัะฝะธั GPT-ะทะฐะฟัะพัะพะฒ.
 *  1) ะกะฝะฐัะฐะปะฐ ะฟัะพะฑัะตะผ ะปะพะบะฐะปัะฝัะต RegExp-ะฟะฐััะตัะฝั (โ ะผะณะฝะพะฒะตะฝะฝะพ, ะฑะตัะฟะปะฐัะฝะพ)
 *  2) ะัะปะธ ะฝะต ะฝะฐัะปะธ โ ัะฟัะฐัะธะฒะฐะตะผ GPT, ะฝะพ ะถัััะบะพ ะพะณัะฐะฝะธัะธะฒะฐะตะผ ัะฟะธัะพะบ ัะตะณะพะฒ
 * ----------------------------------------------------------------
 */

import OpenAI from "openai";
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });

/* โโโโโโ ะธะฝัะตะฝั โ id ัะทะปะฐ ะฒ flow.ts โโโโโโ */
export const INTENTS = {
  yes:        "yes",       // ยซะะฐยป
  no:         "no",        // ยซะะตัยป
  continue:   "continue",       // ยซะะพะตัะฐะปะธยป, ยซะะฐะปััะตยป
  dietary_choice:   "dietary_choice",       // ะผััะพ, ััะฑะฐ ะธ ัะฟ
  dresscode:  "dresscode",  // ะะฐะบะพะน ะดัะตัั-ะบะพะด?
  route:      "route",      // ะะฐะบ ะฟัะพะตัะฐัั?
  venue:      "venue",      // ะะดะต (ะฐะดัะตั)?
  time:       "time",       // ะะพะณะดะฐ ะฝะฐัะฐะปะพ?
} as const;

export type Intent = keyof typeof INTENTS;

/* โโโโโโ ะปะพะบะฐะปัะฝัะต ะบะปััะตะฒัะต ัะปะพะฒะฐ ะดะปั ะบะฐะถะดะพะณะพ ะธะฝัะตะฝัะฐ โโโโโโ */
const INTENT_PATTERNS: Record<Intent, RegExp[]> = {
  yes: [
    /^(ะดะฐ|ะฐะณะฐ|ะบะพะฝะตัะฝะพ|ัะพะณะปะฐั[ะฐั]ัั|ะฑัะด[ั]|ะฟัะธะตะดั)/i,
  ],
  no: [
    /^(ะฝะตั|ะฝะตะฐ|ัะฒั|ะฝะต ัะผะพะณั|ะบ ัะพะถะฐะปะตะฝะธั)/i,
  ],
  continue: [
    /(ะดะฐะปััะต|ะฟัะพะดะพะปะถะธัั|ะดะตัะฐะปะธ|ะฟะพะตัะฐะปะธ|go on|ะพะบะตะน|ok|ะณะพัะพะฒ)/i,
  ],
  dresscode: [
    /(dress.?code|ะดัะตัั.?ะบะพะด|ะฒะพ.?ััะพ|ะพะดะตัััั|ะฝะฐััะด)/i,
  ],
  route: [
    /(ะบะฐะบ.*(ะดะพะตัะฐัั|ะดะพะฑัะฐัััั|ะฟัะพะตัะฐัั)|ะดะพัะพะณะฐ|ะผะฐััััั|ััะฐะฝัะฟะพัั)/i,
  ],
  venue: [
    /(ะณะดะต|ะฐะดัะตั|ะผะตััะพ\s*ะฟัะพะฒะตะดะตะฝะธั|ะปะพะบะฐั)/i,
  ],
  time: [
    /(ะบะพะณะดะฐ|ะฒะพ\s*ัะบะพะปัะบะพ|ะฝะฐัะฐะปะพ|ัะฐะนะผะธะฝะณ|ัะฐัะฟะธัะฐะฝะธะต)/i,
  ],
  dietary_choice: [
    // ะฒะตะณะตัะฐัะธะฐะฝััะฒะพ / ะฒะตะณะฐะฝััะฒะพ
    /(ะฒะตะณะฐะฝ|ะฒะตะณะตัะฐัะธะฐะฝ(ะตั|ะบะฐ|ััะฒะพ)|plant.?based)/i,

    // ยซะฑะตะท โฆยป
    /(ะฑะตะท\s*(ะผััะฐ|ััะฑั|ะณะปััะตะฝะฐ|ะปะฐะบัะพะทั|ะผะพะปะพะบะฐ|ะพัะตัะพะฒ|sea\s*food|seafood))/i,

    // ะฟััะผะพะต ัะบะฐะทะฐะฝะธะต ะฟัะตะดะฟะพััะตะฝะธั
    /(ะตะผ|ะฟัะตะดะฟะพัะธัะฐั|ะปัะฑะปั).*(ัะพะปัะบะพ)?\s*(ะผััะพ|ััะฑั|ััะฑะบั|ะฟัะธัั|ะพะฒะพัะธ)/i,

    // ะฐะฝะณะปะธะนัะบะธะต shortโัะพัะผั
    /(meat|fish|pescatarian|vegan|vegetarian|gluten[- ]?free|lactose[- ]?free)/i,

    // ะฐะปะปะตัะณะธะธ
    /(ะฐะปะปะตัะณะธ(ั|ะธ)\s*ะฝะฐ\s*(ะณะปััะตะฝ|ะพัะตัะธ|ะผะพะปะพะบะพ|ะปะฐะบัะพะทั|ะผะพัะตะฟัะพะดัะบัั|seafood))/i,
    /(^|\s)(ะผััะพ|ััะตะนะบ|ะณัะธะปั|barbeque|meat|๐ฅฉ|๐|๐)(\s|$)/i,

    /** ๐ ะัะฑะฐ, ะผะพัะตะฟัะพะดัะบัั */
    /(^|\s)(ััะฑ(ะฐ|ั|ั|ะพะน|ะต)|fish|ะผะพัะตะฟัะพะดัะบัั|seafood|๐ฃ|๐|๐ฆ|๐ฆ)(\s|$)/i,

    /** ๐ฟ ะะตะณะตัะฐัะธะฐะฝััะฒะพ / ะฒะตะณะฐะฝััะฒะพ / ะฟะตัะบะตัะฐัะธะฐะฝััะฒะพ */
    /\b(ะฒะตะณะฐะฝ(?:ััะฒะพ)?|ะฒะตะณะตัะฐัะธะฐะฝ(?:ะตั|ะบะฐ|ััะฒะพ)?|ะฟะตัะบ[ะตะพ]ัะฐัะธะฐะฝ\w*|vegetarian|vegan|pescatarian)\b/i,

    /** ๐ซ ะะปะปะตัะณะธะธ / ยซะฑะตะท โฆยป */
    /\bะฑะตะท\s+(ะผััะฐ|ััะฑั|ะณะปััะตะฝะฐ|ะปะฐะบัะพะทั|ะพัะตัะพะฒ|ัะฐัะฐัะฐ)\b/i,

    /**  ะะฑัะธะน ะพัะฒะตั ยซะฝะตั ะฟัะตะดะฟะพััะตะฝะธะนยป โ ะฟะพะผะพะณะธ ะพัะปะพะฒะธัั ะธ ะทะดะตัั */
    /^(\s*ะฝะตั\s*$|\s*ะฑะตะท\s*ัะฐะทะฝะธัั\s*$)/i,
  ],
};

/* โโโโโโ ะณะปะฐะฒะฝัะน ัะบัะฟะพัั โโโโโโ */
export async function detectIntent(
  input: string,
): Promise<Intent | "unknown"> {

  const text = input.trim().toLowerCase();

  /* 1๏ธโฃ  ะฑัััััะต RegExp-ะฟะฐััะตัะฝั */
  for (const intent of Object.keys(INTENT_PATTERNS) as Intent[]) {
    if (INTENT_PATTERNS[intent].some(rx => rx.test(text))) {
      return intent;
    }
  }

  /* 2๏ธโฃ  GPT-fallback (ัะตะดะบะพ) */
  const prompt = `
ะขั โ ะฐััะธััะตะฝั ัะฒะฐะดะตะฑะฝะพะณะพ ะฑะพัะฐ.  
ะะตัะฝะธ ะขะะะฌะะ ะพะดะฝะพ ัะปะพะฒะพ-ัะตะณ ะธะท ัะฟะธัะบะฐ: ${Object.keys(INTENTS).join(", ")}  
ะธะปะธ "unknown", ะตัะปะธ ััะฐะทะฐ ะฝะต ะฟะพะดัะพะดะธั ะฝะธ ะฟะพะด ะพะดะธะฝ.

ะคัะฐะทะฐ ะณะพััั: ยซ${input}ยป
ะขะตะณ:`;

  const r = await openai.chat.completions.create({
    model:        "gpt-3.5-turbo",
    temperature:  0,
    max_tokens:   1,
    messages:     [{ role: "user", content: prompt }],
  });

  const tag = (r.choices[0].message?.content ?? "")
                .trim()
                .toLowerCase() as Intent;

  return tag in INTENTS ? tag : "unknown";
}
